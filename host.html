
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Host (Persistente)</title>
  <style>
    body { background:#111; color:#fff; font-family: monospace; padding:20px; }
    h1 { text-align:center; }
    input, button, select, textarea { font-size:16px; padding:10px; margin:6px 0; width:100%; box-sizing:border-box; }
    .section { margin:20px 0; padding:15px; background:#222; border-radius:8px; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .log { background:#333; padding:8px; border-radius:6px; white-space:pre-wrap; font-size:14px; }
    label { font-weight:700; display:block; margin-top:8px; }
  </style>
</head>
<body>
  <h1>üîê Area Riservata Host</h1>

  <div id="loginSection">
    <p>Inserisci la password per accedere:</p>
    <input type="password" id="hostPassword" placeholder="Password" />
    <button onclick="checkHost()">Entra</button>
    <p id="loginError" style="color:#ff6b6b"></p>
  </div>

  <div id="hostPanel" style="display:none;">
    <div class="section">
      <div class="row">
        <button onclick="exportData()">üì§ Esporta dati</button>
        <label for="importFile">üì• Importa dati (.json)</label>
        <input type="file" id="importFile" accept="application/json" onchange="importData(event)" />
      </div>
      <div class="log" id="seedInfo"></div>
    </div>

    <div class="section">
      <h2>üë• Giocatori</h2>
      <div class="row">
        <input type="text" id="newPlayer" placeholder="Nuovo giocatore" />
        <button onclick="addPlayer()">Aggiungi</button>
      </div>
      <ul id="playerList"></ul>
    </div>

    <div class="section">
      <h2>üìù Task</h2>
      <div class="row">
        <textarea id="newTask" placeholder="Nuovo task..."></textarea>
        <button onclick="addTask()">Aggiungi Task</button>
      </div>
      <ul id="taskList"></ul>
    </div>

    <div class="section">
      <h2>üéØ Assegna Task Casuali</h2>
      <button onclick="assignTasks()">Assegna</button>
      <div class="log" id="assignLog"></div>
    </div>

    <div class="section">
      <h2>üßÆ Assegna Punteggio</h2>
      <div class="row">
        <select id="scorePlayer"></select>
        <select id="scoreValue">
          <option value="10">+10 (Talpa non scoperta)</option>
          <option value="5">+5 (Chi scopre la talpa)</option>
          <option value="2">+2 (Collaboratori)</option>
          <option value="0">0 (Talpa scoperta)</option>
          <option value="-2">-2 (Collaboratori scoperti)</option>
          <option value="-5">-5 (Accusa sbagliata)</option>
        </select>
        <button onclick="assignScore()">Assegna</button>
      </div>
    </div>

    <div class="section">
      <h2>‚ôªÔ∏è Reset Giornata</h2>
      <button onclick="resetDay()">Reset</button>
    </div>
  </div>

  <script>
    const HOST_PASSWORD = "Pneumo98!";
    const DEFAULT_PLAYERS = ["Feddino","Chiaretta","Bomber","Perri","Fef√®","Vax","Alpha"];
    const DEFAULT_TASKS = [
      "Fai in modo che il gruppo perda un mezzo di trasporto",
      "Quando siamo in un ristorante a mangiare, vai in cucina e cucina qualche cosa",
      "Ruba degli oggetti degli altri di continuo senza farti beccare fino a cena",
      "Cerca di convincere almeno la met√† del gruppo +1 a prendere il piatto che ispira meno di tutti sul men√π",
      "Non puoi parlare con un membro del gruppo per tutto il giorno (scrivere o altre forme di comunicazione sono bandite)",
      "Imita un altro membro del gruppo per tutta una giornata",
      "Convinci un gruppo di turisti che non parla italiano che sei una persona famosa in italia",
      "Inventa un ballo ed insegnalo a sconosciuti",
      "Comportati da fascista per tutto il giorno (atteggiamento, commenti, uscite, vestiario)",
      "Sostieni che sei allergico a qualcosa di assurdo (es. 'alle sdraio') e agisci di conseguenza",
      "Comportati come se fossi in un reality show: parlando a una telecamera immaginaria",
      "Insisti per negoziare ogni singolo prezzo, anche nei posti dove √® scritto 'fisso'",
      "Fai amicizia con un venditore ambulante e proponi al gruppo di andare a casa sua",
      "Prova a vendere oggetti tuoi a d un venditore ambulante",
      "Compra spezie al mercato e prepara un piatto ‚Äúlocale‚Äù da far assaggiare agli altri (deve essere immangiabile)",
      "devi imparare uno scioglilingua swahili e recitalo ad alta voce la sera a cena",
      "Inventa una leggenda locale (es. 'la sirena di Nungwi') e raccontala a tutti fingendo che sia vera",
      "Fai finta di essere una guida turistica esperta e inizia un tour improvvisato per dei turisti"
    ];

    function checkHost() {
      const pw = document.getElementById("hostPassword").value;
      if (pw === HOST_PASSWORD) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("hostPanel").style.display = "block";
        ensureSeed();
        renderAll();
      } else {
        document.getElementById("loginError").innerText = "Password errata.";
      }
    }

    // Persistenza
    function get(key, fallback) {
      const raw = localStorage.getItem(key);
      if (raw === null || raw === undefined) return fallback;
      try { return JSON.parse(raw); } catch (e) { return fallback; }
    }
    function set(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

    function ensureSeed() {
      let seeded = localStorage.getItem("seeded");
      let info = [];
      if (!seeded) {
        set("players", DEFAULT_PLAYERS);
        set("tasks", DEFAULT_TASKS);
        set("scores", {});
        localStorage.setItem("seeded","1");
        info.push("‚úÖ Seed eseguito: giocatori e task di default caricati.");
      } else {
        if (!get("players", []).length) set("players", DEFAULT_PLAYERS);
        if (!get("tasks", []).length) set("tasks", DEFAULT_TASKS);
        info.push("‚ÑπÔ∏è Seed gi√† presente: uso dati salvati in questo dispositivo.");
      }
      info.push("üë• Giocatori: " + get("players", []).length);
      info.push("üìù Task: " + get("tasks", []).length);
      document.getElementById("seedInfo").innerText = info.join("\n");
    }

    function exportData() {
      const data = {
        players: get("players", []),
        tasks: get("tasks", []),
        scores: get("scores", {}),
        assignments: get("taskAssignments", {}),
        swapQueue: get("swapQueue", []),
        seeded: localStorage.getItem("seeded") || "0"
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "fuko_data_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.players) set("players", data.players);
          if (data.tasks) set("tasks", data.tasks);
          if (data.scores) localStorage.setItem("scores", JSON.stringify(data.scores));
          if (data.assignments) localStorage.setItem("taskAssignments", JSON.stringify(data.assignments));
          if (data.swapQueue) localStorage.setItem("swapQueue", JSON.stringify(data.swapQueue));
          if (data.seeded) localStorage.setItem("seeded", data.seeded);
          renderAll();
          document.getElementById("seedInfo").innerText = "‚úÖ Dati importati correttamente.";
        } catch(e) {
          document.getElementById("seedInfo").innerText = "‚ùå Errore import: " + e.message;
        }
      };
      reader.readAsText(file);
    }

    function addPlayer() {
      const name = document.getElementById("newPlayer").value.trim();
      if (!name) return;
      const players = get("players", []);
      if (!players.includes(name)) {
        players.push(name);
        set("players", players);
        document.getElementById("newPlayer").value = "";
        renderPlayers();
      }
    }

    function addTask() {
      const task = document.getElementById("newTask").value.trim();
      if (!task) return;
      const tasks = get("tasks", []);
      tasks.push(task);
      set("tasks", tasks);
      document.getElementById("newTask").value = "";
      renderTasks();
    }

    function renderPlayers() {
      const players = get("players", []);
      const list = document.getElementById("playerList");
      const select = document.getElementById("scorePlayer");
      list.innerHTML = "";
      select.innerHTML = "";
      players.forEach(function(p){
        const li = document.createElement("li");
        li.textContent = p;
        list.appendChild(li);
        const opt = document.createElement("option");
        opt.value = p; opt.textContent = p;
        select.appendChild(opt);
      });
    }

    function renderTasks() {
      const tasks = get("tasks", []);
      const list = document.getElementById("taskList");
      list.innerHTML = "";
      tasks.forEach(function(t){
        const li = document.createElement("li");
        li.textContent = t;
        list.appendChild(li);
      });
    }

    function assignTasks() {
      const players = get("players", []);
      let tasks = get("tasks", []).slice();
      const assignments = {};
      const log = [];
      if (players.length === 0 || tasks.length === 0) {
        document.getElementById("assignLog").innerText = "‚ö†Ô∏è Aggiungi prima giocatori e task.";
        return;
      }
      players.forEach(function(p){
        if (tasks.length === 0) {
          log.push("‚ùå Nessun task rimanente per " + p);
        } else {
          const i = Math.floor(Math.random() * tasks.length);
          assignments[p] = tasks[i];
          log.push("‚úÖ " + p + " ha ricevuto un task.");
          tasks.splice(i,1);
        }
      });
      localStorage.setItem("taskAssignments", JSON.stringify(assignments));
      document.getElementById("assignLog").innerText = log.join("\n");
      console.log("üì¶ Assegnazioni:", assignments);
    }

    function assignScore() {
      const player = document.getElementById("scorePlayer").value;
      const delta = parseInt(document.getElementById("scoreValue").value);
      const scores = get("scores", {});
      scores[player] = (scores[player] || 0) + delta;
      localStorage.setItem("scores", JSON.stringify(scores));
      alert("Punteggio aggiornato.");
    }

    function resetDay() {
      localStorage.removeItem("taskAssignments");
      localStorage.removeItem("swapQueue");
      document.getElementById("assignLog").innerText = "üîÅ Giornata resettata (assegnazioni cancellate).";
    }

    function renderAll() {
      renderPlayers();
      renderTasks();
    }
  </script>
</body>
</html>
